name: CI - Testes e Cobertura

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar o PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: xdebug
          tools: composer:v2

      - name: Instalar depend√™ncias
        run: composer install --no-progress --prefer-dist

      - name: Executar testes com PHPUnit e gerar cobertura
        run: vendor/bin/phpunit --coverage-clover=coverage.xml --log-junit=phpunit-report.xml | tee phpunit-output.txt

      - name: Obter resumo da cobertura e estat√≠sticas dos testes
        id: coverage
        run: |
          # Obter cobertura total
          TOTAL_COVERAGE=$(grep -oP '(?<=<coverage line-rate=")[^"]*' coverage.xml | awk '{sum+=$1} END {print sum*100}')
          
          # Obter total de testes
          TOTAL_TESTS=$(grep -oP '(?<=tests=")[^"]*' phpunit-report.xml)
          
          # Obter n√∫mero de falhas
          FAILURES=$(grep -oP '(?<=failures=")[^"]*' phpunit-report.xml)
          
          # Obter n√∫mero de testes ignorados
          SKIPPED=$(grep -oP '(?<=skipped=")[^"]*' phpunit-report.xml)
          
          # Obter tempo de execu√ß√£o
          EXECUTION_TIME=$(grep -oP '(?<=time=")[^"]*' phpunit-report.xml)

          # Exportar vari√°veis de ambiente
          echo "total_coverage=$TOTAL_COVERAGE" >> $GITHUB_ENV
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "failures=$FAILURES" >> $GITHUB_ENV
          echo "skipped=$SKIPPED" >> $GITHUB_ENV
          echo "execution_time=$EXECUTION_TIME" >> $GITHUB_ENV

      - name: Enviar relat√≥rio de cobertura para Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          fail_ci_if_error: true
          verbose: true

      - name: Comentar na Pull Request com os resultados do PHPUnit
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ‚úÖ **PHPUnit Test Coverage Report**
            - üìä **Total Coverage:** `${{ env.total_coverage }}%`
            - üß™ **Total Tests:** `${{ env.total_tests }}`
            - ‚ùå **Failures:** `${{ env.failures }}`
            - ‚ö†Ô∏è **Skipped:** `${{ env.skipped }}`
            - ‚è± **Execution Time:** `${{ env.execution_time }} seconds`
          GITHUB_TOKEN: ${{ secrets.GITHUB_DEV }}
