name: CI - Testes e Cobertura

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar o PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: xdebug
          tools: composer:v2

      - name: Instalar depend√™ncias
        run: composer install --no-progress --prefer-dist

      - name: Executar testes com PHPUnit e gerar cobertura
        run: vendor/bin/phpunit --coverage-clover=coverage.xml --log-junit=phpunit-report.xml | tee phpunit-output.txt

      - name: Obter resumo da cobertura e estat√≠sticas dos testes
        id: coverage
        run: |
          # Extraindo a cobertura total e convertendo para n√∫mero
          TOTAL_COVERAGE=$(awk -F '"' '/<coverage line-rate=/ {printf "%.2f", $2 * 100}' coverage.xml)
          [ -z "$TOTAL_COVERAGE" ] && TOTAL_COVERAGE="0.00"

          # Extraindo estat√≠sticas dos testes
          TOTAL_TESTS=$(awk -F '"' '/tests=/ {print $2}' phpunit-report.xml)
          FAILURES=$(awk -F '"' '/failures=/ {print $2}' phpunit-report.xml)
          SKIPPED=$(awk -F '"' '/skipped=/ {print $2}' phpunit-report.xml)
          EXECUTION_TIME=$(awk -F '"' '/time=/ {print $2}' phpunit-report.xml)

          # Garantir que vari√°veis sejam v√°lidas (se vazias, define como 0)
          printf -v TOTAL_TESTS "%.0f" "${TOTAL_TESTS:-0}"
          printf -v FAILURES "%.0f" "${FAILURES:-0}"
          printf -v SKIPPED "%.0f" "${SKIPPED:-0}"
          printf -v EXECUTION_TIME "%.4f" "${EXECUTION_TIME:-0.0000}"

          # Exportando para o GitHub Actions
          echo "total_coverage=$TOTAL_COVERAGE" >> $GITHUB_ENV
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "failures=$FAILURES" >> $GITHUB_ENV
          echo "skipped=$SKIPPED" >> $GITHUB_ENV
          echo "execution_time=$EXECUTION_TIME" >> $GITHUB_ENV

      - name: Enviar relat√≥rio de cobertura para Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          fail_ci_if_error: true
          verbose: true

      - name: Comentar na Pull Request com os resultados do PHPUnit
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ‚úÖ **PHPUnit Test Coverage Report**
            - üìä **Total Coverage:** `${{ env.total_coverage }}%`
            - üß™ **Total Tests:** `${{ env.total_tests }}`
            - ‚ùå **Failures:** `${{ env.failures }}`
            - ‚ö†Ô∏è **Skipped:** `${{ env.skipped }}`
            - ‚è± **Execution Time:** `${{ env.execution_time }} seconds`
          GITHUB_TOKEN: ${{ secrets.GITHUB_DEV }}
